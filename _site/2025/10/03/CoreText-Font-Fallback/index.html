<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Hello-World">
    <meta name="keyword"  content="">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>CoreText Font Fallback - 袁平 | HusterYP-Blog</title>

    <link rel="canonical" href="http://localhost:4000/2025/10/03/CoreText-Font-Fallback/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/hux-blog.min.css">

    <!-- Pygments Github CSS -->
    <link rel="stylesheet" href="/css/syntax.css">

    <!-- Custom Fonts -->
    <!-- <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="http://cdn.staticfile.org/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">


    <!-- Hux Delete, sad but pending in China
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/
    css'>
    -->


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- ga & ba script hoook -->
    <script></script>
</head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">非专业程序员</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <!-- Known Issue, found by Hux:
            <nav>'s height woule be hold on by its content.
            so, when navbar scale out, the <nav> will cover tags.
            also mask any touch event of tags, unfortunately.
        -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>
                    
                    <li>
                        <a href="/about/">About</a>
                    </li>
                    
                    <li>
                        <a href="/tags/">Tags</a>
                    </li>
                    
                </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        // CLOSE
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        // OPEN
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>


    <!-- Image to hack wechat -->
<!-- <img src="/img/icon_wechat.png" width="0" height="0"> -->
<!-- <img src="/img/tag-bg.jpg" width="0" height="0"> -->

<!-- Post Header -->
<style type="text/css">
    header.intro-header{
        background-image: url('/img/tag-bg.jpg')
    }
</style>
<header class="intro-header" >
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                        <a class="tag" href="/tags/#跨端渲染" title="跨端渲染">跨端渲染</a>
                        
                        <a class="tag" href="/tags/#Font" title="Font">Font</a>
                        
                    </div>
                    <h1>CoreText Font Fallback</h1>
                    
                    
                    <h2 class="subheading">CoreText中的字体级联/Font Fallback机制</h2>
                    
                    <span class="meta">Posted by 袁平 on October 3, 2025</span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

    <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

				<h1 id="一引言">一、引言</h1>

<blockquote>
  <p>本文基于Xcode 16.4，iOS 18.5模拟器分析，不同系统版本可能有区别。</p>
</blockquote>

<p>前面我们介绍了<a href="https://mp.weixin.qq.com/s/fcL6if52qYQUTChEjntHJg">自定义文字排版引擎的原理</a>，其中有一个复杂部分是字体Fallback，本文将通过逆向手段分析CoreText中<code class="highlighter-rouge">CTFontCopyDefaultCascadeListForLanguages</code>的实现，通过了解系统的字体回退实现，可以帮助我们实现更好的生产级别的文字排版引擎。</p>

<p>在开始之前，先介绍下<code class="highlighter-rouge">CTFontCopyDefaultCascadeListForLanguages</code> API，其完整的函数签名如下：</p>

<blockquote>
  <p>官方文档：https://developer.apple.com/documentation/coretext/ctfontcopydefaultcascadelistforlanguages(<em>:</em>:)</p>
</blockquote>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">func</span> <span class="kt">CTFontCopyDefaultCascadeListForLanguages</span><span class="p">(</span>
    <span class="n">_</span> <span class="nv">font</span><span class="p">:</span> <span class="kt">CTFont</span><span class="p">,</span>
    <span class="n">_</span> <span class="nv">languagePrefList</span><span class="p">:</span> <span class="kt">CFArray</span><span class="p">?</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">CFArray</span><span class="p">?</span>
</code></pre></div></div>

<p>一个字体不可能支持所有的Unicode，比如Helvetica不支持中文，PingFang不支持韩文，在实际渲染时，往往是多个字体共同参与完成的，另外不同字体支持的Unicode有交集，那最终选择哪个字体也是有优先级的；<code class="highlighter-rouge">CTFontCopyDefaultCascadeListForLanguages</code>的作用就是：给定一个字体和语言列表，返回系统默认的Fallback列表（也叫级联列表，CascadeList），简单理解就是系统会按这个Fallabck列表进行优先级选择Fallback字体。</p>

<p>在macOS/iOS中，我们也可以通过<code class="highlighter-rouge">kCTFontCascadeListAttribute</code>显示指定Fallback链（如下），这样就能自定义Fallback，当然，如果不指定的话会系统也会启用默认Fallback，来尽量保证文本渲染正确。</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">func</span> <span class="nf">makeAttributedStringWithFallback</span><span class="p">(</span>
    <span class="nv">text</span><span class="p">:</span> <span class="kt">String</span><span class="p">,</span>
    <span class="nv">baseFontName</span><span class="p">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="s">"Helvetica"</span><span class="p">,</span>
    <span class="nv">size</span><span class="p">:</span> <span class="kt">CGFloat</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
    <span class="nv">languages</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s">"zh-Hans"</span><span class="p">,</span> <span class="s">"ja"</span><span class="p">,</span> <span class="s">"ko"</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">NSAttributedString</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">baseFont</span> <span class="o">=</span> <span class="kt">CTFontCreateWithName</span><span class="p">(</span><span class="n">baseFontName</span> <span class="k">as</span> <span class="kt">CFString</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
    <span class="k">let</span> <span class="nv">fallbacks</span> <span class="o">=</span> <span class="kt">CTFontCopyDefaultCascadeListForLanguages</span><span class="p">(</span><span class="n">baseFont</span><span class="p">,</span> <span class="n">languages</span> <span class="k">as</span> <span class="kt">CFArray</span><span class="p">)</span>
        <span class="k">as?</span> <span class="p">[</span><span class="kt">CTFontDescriptor</span><span class="p">]</span> <span class="p">??</span> <span class="p">[]</span>
    <span class="k">var</span> <span class="nv">attributes</span><span class="p">:</span> <span class="p">[</span><span class="kt">CFString</span><span class="p">:</span> <span class="kt">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="nv">kCTFontNameAttribute</span><span class="p">:</span> <span class="n">baseFontName</span><span class="p">,</span>
        <span class="nv">kCTFontSizeAttribute</span><span class="p">:</span> <span class="n">size</span>
    <span class="p">]</span>
  	<span class="c1">// 可以在这里修改fallbacks，来自定义回退</span>
    <span class="k">if</span> <span class="o">!</span><span class="n">fallbacks</span><span class="o">.</span><span class="n">isEmpty</span> <span class="p">{</span>
        <span class="n">attributes</span><span class="p">[</span><span class="n">kCTFontCascadeListAttribute</span><span class="p">]</span> <span class="o">=</span> <span class="n">fallbacks</span>
    <span class="p">}</span>
    <span class="k">let</span> <span class="nv">newDescriptor</span> <span class="o">=</span> <span class="kt">CTFontDescriptorCreateWithAttributes</span><span class="p">(</span><span class="n">attributes</span> <span class="k">as</span> <span class="kt">CFDictionary</span><span class="p">)</span>
    <span class="k">let</span> <span class="nv">finalFont</span> <span class="o">=</span> <span class="kt">CTFontCreateWithFontDescriptor</span><span class="p">(</span><span class="n">newDescriptor</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
    <span class="k">let</span> <span class="nv">attributesDict</span><span class="p">:</span> <span class="p">[</span><span class="kt">NSAttributedString</span><span class="o">.</span><span class="kt">Key</span><span class="p">:</span> <span class="kt">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="o">.</span><span class="nv">font</span><span class="p">:</span> <span class="n">finalFont</span>
    <span class="p">]</span>
    <span class="k">return</span> <span class="kt">NSAttributedString</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span> <span class="n">text</span><span class="p">,</span> <span class="nv">attributes</span><span class="p">:</span> <span class="n">attributesDict</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>下面，我们按如下调用Demo来实际研究下：</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="nv">ctFont</span> <span class="o">=</span> <span class="kt">UIFont</span><span class="o">.</span><span class="nf">systemFont</span><span class="p">(</span><span class="nv">ofSize</span><span class="p">:</span> <span class="mi">16</span><span class="p">)</span>
<span class="k">let</span> <span class="nv">languages</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s">"zh-Hans"</span><span class="p">]</span>
<span class="k">let</span> <span class="nv">cascadeList</span> <span class="o">=</span> <span class="kt">CTFontCopyDefaultCascadeListForLanguages</span><span class="p">(</span><span class="n">ctFont</span><span class="p">,</span> <span class="n">languages</span> <span class="k">as</span> <span class="kt">CFArray</span><span class="p">)</span>
</code></pre></div></div>

<h1 id="二调用链路">二、调用链路</h1>

<p><img src="/img/post/FontFallback/CTFontCopyDefaultCascadeListForLanguages.png" alt="CTFontCopyDefaultCascadeListForLanguages" /></p>

<p>如上是<code class="highlighter-rouge">CTFontCopyDefaultCascadeListForLanguages</code>的调用链路，可以看出大致分为两条处理链路：</p>

<ul>
  <li><strong>Preset Fallbacks</strong>：系统预设Fallback，这是一个“快速通道”，系统内部维护了一个针对特定字体（如系统UI字体）的硬编码Fallback列表，如果请求的主字体在这个预设列表中，系统会直接使用这个列表，速度非常快。</li>
  <li><strong>System Default Fallbacks</strong>：系统默认Fallback，这是一个“通用通道”，如果预设列表没有命中，系统会启动默认Fallback流程，该流程会加载一个全局的、定义了完整回退规则的配置文件，根据用户的语言偏好设置，动态地为请求的字体生成一个Fallback列表，并进行缓存以提高后续调用效率。</li>
</ul>

<p>后文我们也将按这两个流程分开分析。</p>

<p>完整的反汇编逻辑和注释可以参考：https://github.com/HusterYP/FontFallback</p>

<h1 id="三tbasefontcreatefallbacks">三、TBaseFont::CreateFallbacks</h1>

<pre><code class="language-assembly">/**
* 核心分发函数，决定是使用预设Fallback还是系统默认Fallback。
*
* @param result@&lt;X0&gt; (TBaseFont*) TBaseFont 实例。
* @param a2@&lt;X1&gt;     (int) 标志位，可能表示是否为系统UI字体。
* @param a3@&lt;X2&gt;     (int) 字体属性。
* @param a4@&lt;X3&gt;     (_QWORD*) 未知参数，可能是字符集。
* @param a5@&lt;X4&gt;     (CFArrayRef) 语言列表。
* @param a6@&lt;X8&gt;     (_QWORD*) 用于接收结果的输出指针。
*
* @return __int64 无实际意义。
 */
__int64 __usercall TBaseFont::CreateFallbacks@&lt;X0&gt;(__int64 result@&lt;X0&gt;, __int64 a2@&lt;X1&gt;, __int64 a3@&lt;X2&gt;, __int64 a4@&lt;X3&gt;, __int64 a5@&lt;X4&gt;, _QWORD *a6@&lt;X8&gt;)
{
	...
  // 保存参数
  v6 = a3;  // 字体特性标志
  v7 = a5;  // 语言数组指针
  v8 = a2;  // 系统UI字体标志
  v9 = (TBaseFont *)result;  // 基础字体对象
  ...
  // 如果系统UI字体标志不为 0，尝试创建预设字体回退
  if ( (_DWORD)a2 )
  {
    v11 = (_QWORD *)a4;
    // 从字体对象中获取字体名，如.SFUI-Regular
    v12 = (*(__int64 (**)(void))(*(_QWORD *)result + 560LL))();
    if ( v12 )
    {
      v13 = v12;
      // 初始化字体描述符源对象
      TDescriptorSource::TDescriptorSource((TDescriptorSource *)&amp;v33);
      _X26 = &amp;v34;
      // 创建预设字体回退列表
      _X0 = TDescriptorSource::CreatePresetFallbacks(v13, v11, v7, v6, &amp;v34);
      ...
    }
  }
  // 检查预设字体回退是否成功创建
  v24 = objc_retain(_X0);
  if ( v24 )
  {
    v25 = v24;
    v26 = CFArrayGetCount(v24);
    result = objc_release(v25);
    // 如果预设字体回退不为空，直接返回
    if ( v26 )
      return result;
  }
  ...
  // 如果预设字体回退为空，创建系统默认字体回退
  v27 = TBaseFont::GetCSSFamily(v9);
  _X23 = &amp;v34;

  // 创建系统默认字体回退列表
  _X0 = TBaseFont::CreateSystemDefaultFallbacks((__int64)v9, v27, v7, v8, &amp;v34);
  ...
  return result;
}
</code></pre>

<p>这是处理预设Fallback和默认Fallback的入口函数。</p>

<p><strong>1）<code class="highlighter-rouge">result@&lt;X0&gt;</code>参数是什么</strong></p>

<p>首先我们主要关注的是第一个入参<code class="highlighter-rouge">result@&lt;X0&gt;</code>，我们先尝试反汇编x0，发现它其实指向的是类 <code class="highlighter-rouge">TTenuousComponentFont</code> （CoreText 内部的一个私有类，继承自 <code class="highlighter-rouge">TBaseFont</code>）的虚函数表，如下，下面的<code class="highlighter-rouge">udf</code> 其实是因为LLDB尝试将数据当代码解读，但其实它是一个指针表，所以识别成了未定义。</p>

<p><img src="/img/post/FontFallback/CreateFallbacks-1.png" alt="CreateFallbacks-1" /></p>

<p>CoreText 是由 C++ 和 Objective-C 混合实现的，C++类对象的方法调用是通过虚函数表（vtable）实现的，C++ 虚表是一个函数指针数组，对象里保存着一个 vptr（虚表指针），指向它所属类的 vtable。</p>

<p>下面我们尝试将<code class="highlighter-rouge">result@&lt;X0&gt;</code>按虚表指针解析，主要是<code class="highlighter-rouge">dis -c 5 -s xxx</code>，可以通过这种方式索引各方法。</p>

<p><img src="/img/post/FontFallback/CreateFallbacks-2.png" alt="CreateFallbacks" /></p>

<p>继续往上追溯，<code class="highlighter-rouge">result@&lt;X0&gt;</code>其实来自原始入参CTFont中的一个属性。</p>

<p><strong>2）什么情况下会触发Preset Fallbacks</strong></p>

<p>提取主要控制逻辑如下：</p>

<pre><code class="language-assembly">// 如果系统UI字体标志不为 0，尝试创建预设字体回退
if ( (_DWORD)a2 )
{
  v11 = (_QWORD *)a4;
  // 从字体对象中获取字体名，如.SFUI-Regular
  v12 = (*(__int64 (**)(void))(*(_QWORD *)result + 560LL))();
  if ( v12 )
  {
  	...
  }
}
</code></pre>

<p>可以发现当<code class="highlighter-rouge">a2</code>非0时会触发Preset Fallbacks，继续往上追溯<code class="highlighter-rouge">a2</code>来自于<code class="highlighter-rouge">TFont::IsSystemUIFontAndForShaping((TFont *)v5, &amp;v14)</code>，<code class="highlighter-rouge">IsSystemUIFontAndForShaping</code>不在本文重点，简单理解就是如果是系统UI字体且用于文本塑形的字体则返回true，比如典型的<code class="highlighter-rouge">UIFont.systemFont</code>（<code class="highlighter-rouge">.SFUI-Regular</code>：San Francisco (SF)字体家族中的字体）判定为true。</p>

<blockquote>
  <p>Q：为什么只有系统UI字体才有预设Fallback</p>

  <p>简单理解就是只有系统UI字体是系统完全可控可感知的，所以可以提前构建Fallback列表</p>
</blockquote>

<p><strong>3）什么情况下会触发System Default Fallbacks</strong></p>

<p>从上面反汇编逻辑比较容易看出，当Preset Fallbacks的结果为空时，会继续走System Default Fallbacks兜底。</p>

<h1 id="四preset-fallbacks">四、Preset Fallbacks</h1>

<h2 id="41-获取全局预设fallback列表ctpresetfallbacks">4.1 获取全局预设Fallback列表CTPresetFallbacks</h2>

<p>在分析系统是如何为特定字体构建预设Fallback（字体的级联列表）之前，我们需要先知道预设列表是从哪里读取的。</p>

<p>系统是通过<code class="highlighter-rouge">GetCTPresetFallbacksDictionary</code>获取预设列表的，继续往下追溯预设列表最终来自<code class="highlighter-rouge">GSFontCacheGetData</code>：</p>

<pre><code class="language-assembly">/*
 * 函数: GSFontCacheGetData
 * -------------------------
 * @brief  从图形服务（GraphicsServices）的字体缓存中根据键名获取数据。
 * @param  a1 (void*)      String入参，实际是对应plist名称，比如预设列表的plist名称CTPresetFallbacks.plist
 * @param  a2 (const char*) 在此反汇编中未使用，可能是寄存器传参的残留。
 * @return (void*)         返回一个指向缓存数据的指针，如果找不到则可能返回NULL。
 */
void *__fastcall GSFontCacheGetData(void *a1, const char *a2)
{
  // =================================================================
  // 快速通道 1: 检查是否请求 "DefaultFontFallbacks.plist"
  // =================================================================
  // 调用 a1 的 isEqualToString: 方法，与字符串 "DefaultFontFallbacks.plist"（stru_6BEB8）比较
  if ( (unsigned int)objc_msgSend_isEqualToString_(a1, a2, &amp;stru_6BEB8) )
  {
    // 如果是，直接返回全局变量 kDefaultFontFallbacks 的值。
    // 这是一个非常高效的硬编码路径，用于获取默认的后备字体规则。
    v4 = &amp;kDefaultFontFallbacks;
    return (void *)*v4;
  }

  // =================================================================
  // 快速通道 2: 检查是否请求 "CTPresetFallbacks.plist"
  // =================================================================
  // 调用 a1 的 isEqualToString: 方法，与字符串 "CTPresetFallbacks.plist"（stru_6BED8）比较
  if ( (unsigned int)objc_msgSend_isEqualToString_(v2, v3, &amp;stru_6BED8) )
  {
    // 如果是，直接返回全局变量 CTPresetFallbacks 的值。
    // 这正是我们之前分析的、包含了所有预设后备规则的那个.plist文件的内容。
    // 系统通过这个键来加载整个预设后备字典。
    v4 = &amp;CTPresetFallbacks;
    return (void *)*v4;
  }

  // =================================================================
  // 快速通道 3: 检查是否请求某个特殊字典
  // =================================================================
  // 调用 a1 的 isEqualToString: 方法，与字符串 "CTFontInfo.plist"（stru_6BEF8）比较
  if ( !((unsigned __int64)objc_msgSend_isEqualToString_(v2, v5, &amp;stru_6BEF8) &amp; 1) )
  {
    // 如果键不是 stru_6BEF8，则进入下面的常规查询逻辑
    // =================================================================
    // 常规查询路径: 在一个全局字典 (unk_1EB8F0) 中查找
    // =================================================================
    // 检查键是否为 "CTCharacterSets.plist" (stru_6BF18)
    if ( (unsigned int)objc_msgSend_isEqualToString_(v2, v7, &amp;stru_6BF18) )
    {
      // **键名转换/别名**: 如果是，则将要查询的键替换为另一个字符串 "CTCharacterSets" (stru_6BF38)
      v9 = &amp;stru_6BF38;
    }
    // 检查键是否为 "GSFontCache.plist" (stru_6BF58)
    else if ( (unsigned int)objc_msgSend_isEqualToString_(v2, v8, &amp;stru_6BF58) )
    {
      // **键名转换/别名**: 如果是，则将要查询的键替换为另一个字符串 "GSFontCache" (stru_6BF78)
      v9 = &amp;stru_6BF78;
    }
    else
    {
      // 检查键是否为 "CoreTextConfig.plist" (stru_6BF98)
      if ( !(unsigned int)objc_msgSend_isEqualToString_(v2, v8, &amp;stru_6BF98) )
        // 如果键不匹配上面任何一个需要转换的键，则使用原始的键 v2 在全局字典中查找
        return objc_msgSend_objectForKey_(&amp;unk_1EB8F0, v8, v2);
      
      // **键名转换/别名**: 如果键是 stru_6BF98，则将其替换为 "CoreTextConfig" (stru_6BFB8)
      v9 = &amp;stru_6BFB8;
    }
    
    // 对于所有经过“键名转换”的情况，使用转换后的新键 v9 在全局字典中查找
    // objectForKeyedSubscript: 是 OC 中字典下标语法 (dictionary[key]) 的底层实现
    return objc_msgSend_objectForKeyedSubscript_(&amp;unk_1EB8F0, v8, v9);
  }

  // 如果快速通道3的检查为真 (键等于 stru_6BEF8)，则直接返回整个全局字典 unk_1EB8F0
  return &amp;unk_1EB8F0;
}
</code></pre>

<p>从反汇编逻辑不太容易看，可以结合LLDB Debug一起分析：</p>

<p><img src="/img/post/FontFallback/CTPresetFallbacks-plist.png" alt="CTPresetFallbacks-plist" /></p>

<p>在查询预设列表时，入参是<code class="highlighter-rouge">CTPresetFallbacks.plist</code>，系统会从<strong>全局变量CTPresetFallbacks</strong>中读取预设列表，CTPresetFallbacks是全局共享的，是在CoreText服务启动时构建的一个全局常量，内容如下：</p>

<blockquote>
  <p>完整列表见：https://github.com/HusterYP/FontFallback/blob/main/CTPresetFallbacks.plist</p>
</blockquote>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="err">...</span><span class="w">
  </span><span class="s2">".SFUI-Regular"</span><span class="w"> </span><span class="err">=</span><span class="w">     </span><span class="err">(</span><span class="w">
        </span><span class="s2">".AppleSystemFallback-Regular"</span><span class="p">,</span><span class="w">
        </span><span class="s2">".AppleColorEmojiUI"</span><span class="p">,</span><span class="w">
        </span><span class="s2">".SFGeorgian-Regular"</span><span class="p">,</span><span class="w">
        </span><span class="err">HelveticaNeue</span><span class="p">,</span><span class="w">
        </span><span class="s2">".AppleSymbolsFB"</span><span class="p">,</span><span class="w">
                </span><span class="p">{</span><span class="w">
            </span><span class="err">ar</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="s2">".AppleArabicFont-Regular"</span><span class="err">;</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">如果系统语言是阿拉伯语(ar)，则使用此字体</span><span class="w">
            </span><span class="err">ur</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="s2">".AppleUrduFont-Regular"</span><span class="err">;</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">如果是乌尔都语(ur)，则使用此字体</span><span class="w">
        </span><span class="p">},</span><span class="w">
                </span><span class="p">{</span><span class="w">
            </span><span class="err">ja</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="s2">".AppleJapaneseFont-Regular"</span><span class="err">;</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">如果是日语(ja)</span><span class="w">
            </span><span class="err">ko</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="s2">".AppleKoreanFont-Regular"</span><span class="err">;</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">如果是韩语(ko)</span><span class="w">
            </span><span class="err">my</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="s2">"NotoSansMyanmar-Regular"</span><span class="err">;</span><span class="w">
            </span><span class="s2">"my-Qaag"</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="s2">"NotoSansZawgyi-Regular"</span><span class="err">;</span><span class="w">
            </span><span class="s2">"zh-HK"</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="s2">".AppleHongKongChineseFont-Regular"</span><span class="err">;</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">香港繁体中文</span><span class="w">
            </span><span class="s2">"zh-Hans"</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="s2">".AppleSimplifiedChineseFont-Regular"</span><span class="err">;</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">简体中文</span><span class="w">
            </span><span class="s2">"zh-Hant"</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="s2">".AppleTraditionalChineseFont-Regular"</span><span class="err">;</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">台湾繁体中文</span><span class="w">
            </span><span class="s2">"zh-MO"</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="s2">".AppleMacaoChineseFont-Regular"</span><span class="err">;</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="s2">".ThonburiUI-Regular"</span><span class="p">,</span><span class="w">
        </span><span class="s2">".SFHebrew-Regular"</span><span class="p">,</span><span class="w">
        </span><span class="s2">".SFArmenian-Regular"</span><span class="p">,</span><span class="w">
        </span><span class="s2">".AppleIndicFont-Regular"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"KohinoorDevanagari-Regular"</span><span class="p">,</span><span class="w">
        </span><span class="err">Kailasa</span><span class="p">,</span><span class="w">
        </span><span class="s2">"KohinoorBangla-Regular"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"KohinoorGujarati-Regular"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"MuktaMahee-Regular"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"NotoSansKannada-Regular"</span><span class="p">,</span><span class="w">
        </span><span class="err">KhmerSangamMN</span><span class="p">,</span><span class="w">
        </span><span class="err">LaoSangamMN</span><span class="p">,</span><span class="w">
        </span><span class="err">MalayalamSangamMN</span><span class="p">,</span><span class="w">
        </span><span class="err">NotoSansOriya</span><span class="p">,</span><span class="w">
        </span><span class="err">SinhalaSangamMN</span><span class="p">,</span><span class="w">
        </span><span class="err">TamilSangamMN</span><span class="p">,</span><span class="w">
        </span><span class="s2">"KohinoorTelugu-Regular"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"NotoSansArmenian-Regular"</span><span class="p">,</span><span class="w">
        </span><span class="err">EuphemiaUCAS</span><span class="p">,</span><span class="w">
        </span><span class="s2">"Menlo-Regular"</span><span class="p">,</span><span class="w">
        </span><span class="err">AppleSymbols</span><span class="p">,</span><span class="w">
        </span><span class="err">ArialMT</span><span class="p">,</span><span class="w">
        </span><span class="s2">"STIXTwoMath-Regular"</span><span class="p">,</span><span class="w">
        </span><span class="s2">".HiraKakuInterface-W4"</span><span class="p">,</span><span class="w">
        </span><span class="err">HelveticaNeue</span><span class="p">,</span><span class="w">
        </span><span class="s2">"Kefa-Regular"</span><span class="p">,</span><span class="w">
        </span><span class="err">Galvji</span><span class="p">,</span><span class="w">
        </span><span class="s2">".PhoneFallback"</span><span class="w">
    </span><span class="err">);</span><span class="w">
    </span><span class="err">SystemWideFallbacks</span><span class="w"> </span><span class="err">=</span><span class="w">     </span><span class="err">(</span><span class="w">
                </span><span class="err">(</span><span class="w">
            </span><span class="mi">128</span><span class="p">,</span><span class="w">
            </span><span class="mi">887</span><span class="p">,</span><span class="w">
            </span><span class="s2">"Charter-Roman"</span><span class="w">
        </span><span class="err">)</span><span class="p">,</span><span class="w">
                </span><span class="err">(</span><span class="w">
            </span><span class="mi">895</span><span class="p">,</span><span class="w">
            </span><span class="mi">895</span><span class="p">,</span><span class="w">
            </span><span class="s2">"DINCondensed-Bold"</span><span class="w">
        </span><span class="err">)</span><span class="p">,</span><span class="w">
                </span><span class="err">(</span><span class="w">
            </span><span class="mi">975</span><span class="p">,</span><span class="w">
            </span><span class="mi">1315</span><span class="p">,</span><span class="w">
            </span><span class="s2">"Charter-Roman"</span><span class="w">
        </span><span class="err">)</span><span class="p">,</span><span class="w">
                </span><span class="err">(</span><span class="w">
            </span><span class="mi">1316</span><span class="p">,</span><span class="w">
            </span><span class="mi">1319</span><span class="p">,</span><span class="w">
            </span><span class="s2">".SFUI-Regular"</span><span class="w">
        </span><span class="err">)</span><span class="p">,</span><span class="w">
				</span><span class="err">...</span><span class="w">
    </span><span class="err">)</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>CTPresetFallbacks.plist中主要定义了两组内容：</p>

<p><strong>1）为特定字体定义Fallback列表/级联列表</strong></p>

<p>比如我们这里要查询<code class="highlighter-rouge">.SFUI-Regular</code>的Fallback列表，就用<code class="highlighter-rouge">.SFUI-Regular</code>作为key去CTPresetFallbacks.plist中找到一组字典进行解析，解析逻辑后面会讲。</p>

<p><strong>2）SystemWideFallbacks</strong></p>

<p>SystemWideFallbacks定义了一个全局级别的 Fallback 映射，和字体无关，按 Unicode code point 范围定义；每个元素是一个三元组，包括：起始 Unicode 码点 + 结束 Unicode 码点 + 指定 Fallback 字体。</p>

<p>比如128～887范围优先用Charter-Roman。</p>

<h2 id="42-预设列表解析流程">4.2 预设列表解析流程</h2>

<p>获取到全局预设列表之后，我们再来看系统是如何针对特定字体（系统的UI字体）构建级联列表的，主要逻辑在<code class="highlighter-rouge">CreatePresetFallbacks</code>中，如下：</p>

<pre><code class="language-assembly">/*
* 实现“快速通道”，从一个全局的、硬编码的字典中查找并创建预设列表。
*
* @param a1@&lt;X1&gt; (CFStringRef) 字体名称或标识符。
* @param a2@&lt;X2&gt; (_QWORD*)     输出参数，可能用于字符集。
* @param a3@&lt;X3&gt; (CFArrayRef)  语言列表。
* @param a4@&lt;X4&gt; (int)         标志位。
* @param a5@&lt;X8&gt; (_QWORD*)     用于接收结果的输出指针。
*
* @return __int64 返回创建的预设列表 (CFArrayRef)。
*/
__int64 __usercall TDescriptorSource::CreatePresetFallbacks@&lt;X0&gt;(__int64 a1@&lt;X1&gt;, _QWORD *a2@&lt;X2&gt;, __int64 a3@&lt;X3&gt;, __int64 a4@&lt;X4&gt;, _QWORD *a5@&lt;X8&gt;)
{
  ...
  _X19 = a5;
  // 1. 获取全局预设字典
  result = GetCTPresetFallbacksDictionary();
  v11 = result;
  // 2. 创建有序的语言列表
  v12 = CreateOrderedLanguages(v6);
  // 3. 使用字体名 a1 在预设字典中查找
  v13 = CFDictionaryGetValue(v11, v8);
  // 4. 如果找到匹配项，并且它是一个数组，则开始处理
  if ( v13 &amp;&amp; (v15 = v13, v16 = CFGetTypeID(v13), v16 == CFArrayGetTypeID()) )
  {
    // 创建一个可变数组用于存放结果
    v37 = CFArrayCreateMutable(*(_QWORD *)kCFAllocatorDefault_ptr, 0LL, kCFTypeArrayCallBacks_ptr);
    v17 = CFArrayGetCount(v15);
    if ( v17 )
    {
      // 5. 遍历预设数组中的每一项
      do
      {
        v20 = (__CFString *)CFArrayGetValueAtIndex(v15, v19);
        v21 = CFGetTypeID(v20);
				// 5a. 如果是字典类型，说明是按语言区分的后备字体
        if ( v21 == CFDictionaryGetTypeID() )
        {
          // 遍历上面构建的语言列表，在字典中查找匹配的后备字体
          do
          {
            v25 = CFArrayGetValueAtIndex(v12, v24);
            if ( v20 )
            {
              v26 = CFDictionaryGetValue(v20, v25);
              if ( v26 )
                TDescriptorSource::AppendFontDescriptorFromName(&amp;v37, v26, 1024LL);
            }
          }
          while ( v23 != v24 );
        }
        // 5b. 如果是字符串类型，直接作为后备字体名
        else
        {
          // ... 对Emoji等特殊字体进行处理 ...
          TDescriptorSource::AppendFontDescriptorFromName(&amp;v37, v20, 1024LL);
        }
        ++v19;
      }
      while ( v19 != v18 );
    }
  }
  // 将最终结果写入输出指针并返回
  ...
}
</code></pre>

<p>代码注释已经比较清晰，总结下来解析流程是：</p>

<p><strong>1）通过字体名从全局预设列表中查询Fallback数组</strong></p>

<p>比如我们通过<code class="highlighter-rouge">.SFUI-Regular</code>查询到的原始Fallback数组如下：</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s2">".SFUI-Regular"</span><span class="w"> </span><span class="err">=</span><span class="w">     </span><span class="err">(</span><span class="w">
        </span><span class="s2">".AppleSystemFallback-Regular"</span><span class="p">,</span><span class="w">
        </span><span class="s2">".AppleColorEmojiUI"</span><span class="p">,</span><span class="w">
        </span><span class="s2">".SFGeorgian-Regular"</span><span class="p">,</span><span class="w">
        </span><span class="err">HelveticaNeue</span><span class="p">,</span><span class="w">
        </span><span class="s2">".AppleSymbolsFB"</span><span class="p">,</span><span class="w">
                </span><span class="p">{</span><span class="w">
            </span><span class="err">ar</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="s2">".AppleArabicFont-Regular"</span><span class="err">;</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">如果系统语言是阿拉伯语(ar)，则使用此字体</span><span class="w">
            </span><span class="err">ur</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="s2">".AppleUrduFont-Regular"</span><span class="err">;</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">如果是乌尔都语(ur)，则使用此字体</span><span class="w">
        </span><span class="p">},</span><span class="w">
                </span><span class="p">{</span><span class="w">
            </span><span class="err">ja</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="s2">".AppleJapaneseFont-Regular"</span><span class="err">;</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">如果是日语(ja)</span><span class="w">
            </span><span class="err">ko</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="s2">".AppleKoreanFont-Regular"</span><span class="err">;</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">如果是韩语(ko)</span><span class="w">
            </span><span class="err">my</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="s2">"NotoSansMyanmar-Regular"</span><span class="err">;</span><span class="w">
            </span><span class="s2">"my-Qaag"</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="s2">"NotoSansZawgyi-Regular"</span><span class="err">;</span><span class="w">
            </span><span class="s2">"zh-HK"</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="s2">".AppleHongKongChineseFont-Regular"</span><span class="err">;</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">香港繁体中文</span><span class="w">
            </span><span class="s2">"zh-Hans"</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="s2">".AppleSimplifiedChineseFont-Regular"</span><span class="err">;</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">简体中文</span><span class="w">
            </span><span class="s2">"zh-Hant"</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="s2">".AppleTraditionalChineseFont-Regular"</span><span class="err">;</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">台湾繁体中文</span><span class="w">
            </span><span class="s2">"zh-MO"</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="s2">".AppleMacaoChineseFont-Regular"</span><span class="err">;</span><span class="w">
        </span><span class="p">},</span><span class="w">
	  	</span><span class="err">...</span><span class="w">
</span><span class="err">)</span><span class="w">
</span></code></pre></div></div>

<p><strong>2）遍历Fallback数组，如果是字典类型，需要按语言区分Fallback字体</strong></p>

<p>还记得最初<code class="highlighter-rouge">CTFontCopyDefaultCascadeListForLanguages</code>的函数签名中，第二个参数支持传语言列表：</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">func</span> <span class="kt">CTFontCopyDefaultCascadeListForLanguages</span><span class="p">(</span>
    <span class="n">_</span> <span class="nv">font</span><span class="p">:</span> <span class="kt">CTFont</span><span class="p">,</span>
    <span class="n">_</span> <span class="nv">languagePrefList</span><span class="p">:</span> <span class="kt">CFArray</span><span class="p">?</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">CFArray</span><span class="p">?</span>
</code></pre></div></div>

<p>系统会通过<code class="highlighter-rouge">CreateOrderedLanguages</code>创建一个有序的语言数组，具体做法是将调用者想要的语言（languagePrefList）、App自身想要的语言、以及用户在整个系统中设置的语言偏好合并成一个有序的语言数组。</p>

<p>然后遍历语言数组，从字典中筛选出对应语言的Fallback字体添加到结果中。</p>

<p>从这里可以看出，<strong>同一字体的Fallback列表，还会受语言影响</strong>，比如：</p>

<table>
  <thead>
    <tr>
      <th>zh-Hans</th>
      <th>zh-HK</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><img src="/img/post/FontFallback/zh-Hans.png" alt="zh-Hans" /></td>
      <td><img src="/img/post/FontFallback/zh-HK.png" alt="zh-HK" /></td>
    </tr>
  </tbody>
</table>

<blockquote>
  <p>Q：为什么Fallback字体还跟语言设置相关?</p>

  <p>参考<a href="https://mp.weixin.qq.com/s/fcL6if52qYQUTChEjntHJg">自定义文字排版引擎的原理</a>一文中针对「相同Script的字符如果使用了不同的Font，会有什么问题」的回答</p>
</blockquote>

<p><strong>3）遍历Fallback数组，如果是字符串类型，「直接」作为Fallback字体</strong></p>

<p>「直接」加引号，因为还会处理Emoji字体等特殊情况。</p>

<p><strong>4）Fallback数组遍历完成之后，构建完成该字体最终的预设Fallabck列表/级联列表</strong></p>

<h2 id="42-preset-fallbacks小结">4.2 Preset Fallbacks小结</h2>

<p>总结下Preset Fallbacks流程：</p>

<p><strong>1）系统从全局常量CTPresetFallbacks中读取预设列表</strong></p>

<p><strong>2）根据用户指定主字体名从全局预设列表中查询Fallback数组</strong></p>

<p><strong>3）遍历Fallback数组，如果为字典类型，根据用户指定语言、App偏好语言、系统设置偏好语言来选择Fallback字体</strong></p>

<p><strong>4）遍历Fallback数组，如果为字符串类型，「直接」作为Fallback字体</strong></p>

<p><strong>5）Fallback数组遍历完后，对应字体的级联列表构建完成</strong></p>

<h1 id="五system-default-fallbacks">五、System Default Fallbacks</h1>

<p>如果系统预设Fallback没有查到结果，则会兜底到系统默认Fallback逻辑，为字体动态构建级联列表。</p>

<h2 id="51-cssfamily分类">5.1 CSSFamily分类</h2>

<pre><code class="language-assembly">__int64 __usercall TBaseFont::CreateFallbacks@&lt;X0&gt;(__int64 result@&lt;X0&gt;, __int64 a2@&lt;X1&gt;, __int64 a3@&lt;X2&gt;, __int64 a4@&lt;X3&gt;, __int64 a5@&lt;X4&gt;, _QWORD *a6@&lt;X8&gt;)
{
  ...
  // 如果预设字体回退为空，创建系统默认字体回退
  v27 = TBaseFont::GetCSSFamily(v9);
  _X23 = &amp;v34;

  // 创建系统默认字体回退列表
  _X0 = TBaseFont::CreateSystemDefaultFallbacks((__int64)v9, v27, v7, v8, &amp;v34);
  ...
  return result;
}
</code></pre>

<p>系统默认Fallback，会先通过<code class="highlighter-rouge">TBaseFont::GetCSSFamily</code>将用户指定主字体分类，这是后续查表的关键；GetCSSFamily会读取字体特征进行分类，主要分为：</p>

<ul>
  <li><strong><code class="highlighter-rouge">sans-serif</code> (无衬线体)</strong>：字体笔画的末端没有额外的装饰性“脚”，如Helvetica、Arial、San Francisco (SF Pro)、PingFang SC (苹方)</li>
  <li><strong><code class="highlighter-rouge">serif</code> (衬线体)</strong>：字体笔画的末端有装饰性的“脚”（衬线），如Times New Roman、Georgia、New York、宋体</li>
  <li><strong><code class="highlighter-rouge">monospace</code> (等宽体)</strong>：所有字符占据相同的宽度，如Menlo、Courier、Monaco、SF Mono</li>
  <li><strong><code class="highlighter-rouge">cursive</code> (手写体)</strong>：如Snell Roundhand</li>
  <li><strong><code class="highlighter-rouge">fantasy</code> (装饰体)</strong>：如Papyrus</li>
</ul>

<p>除此外，苹果在UI上下文中，还有几个扩展的CSSFamily分类：</p>

<ul>
  <li>
    <p><strong><code class="highlighter-rouge">ui-serif</code></strong>：用于 UI 的衬线字体，主要指 <code class="highlighter-rouge">New York</code> 家族</p>
  </li>
  <li>
    <p><strong><code class="highlighter-rouge">ui-sans-serif</code></strong>：用于 UI 的无衬线字体，即 <code class="highlighter-rouge">San Francisco</code> 家族</p>
  </li>
  <li>
    <p><strong><code class="highlighter-rouge">ui-monospace</code></strong>：用于 UI 的等宽字体，即 <code class="highlighter-rouge">SF Mono</code>。</p>
  </li>
  <li>
    <p><strong><code class="highlighter-rouge">ui-rounded</code></strong>：用于 UI 的圆体字体。如 <code class="highlighter-rouge">SF Pro Rounded</code> 和 <code class="highlighter-rouge">SF Compact Rounded</code></p>
  </li>
</ul>

<h2 id="52-获取系统默认fallback列表kdefaultfontfallbacks">5.2 获取系统默认Fallback列表kDefaultFontFallbacks</h2>

<p>和全局预设列表一样，系统默认Fallback列表也是通过<code class="highlighter-rouge">GSFontCacheGetData</code>读取配置文件。</p>

<p>调用链路是：<code class="highlighter-rouge">CreateSystemDefaultFallbacks -&gt; CopyDefaultSubstitutionListForLanguages -&gt; CopyFontFallbacksForLanguages -&gt; CopyFontFallbacks -&gt; CopyDefaultFontFallbacks -&gt; GSFontCacheGetData</code>；通过GSFontCacheGetData读取系统默认Fallback列表时，入参是<code class="highlighter-rouge">DefaultFontFallbacks.plist</code></p>

<p><img src="/img/post/FontFallback/DefaultFontFallbacks.plist.png" alt="DefaultFontFallbacks.plist" /></p>

<p>也是从一个全局常量<code class="highlighter-rouge">kDefaultFontFallbacks</code>中获取的，内容如下：</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="err">common</span><span class="w"> </span><span class="err">=</span><span class="w">     </span><span class="err">(</span><span class="w">
        </span><span class="err">...</span><span class="w">
    </span><span class="err">);</span><span class="w">
    </span><span class="err">cursive</span><span class="w"> </span><span class="err">=</span><span class="w">     </span><span class="err">(</span><span class="w">
        </span><span class="err">...</span><span class="w">
    </span><span class="err">);</span><span class="w">
    </span><span class="err">default</span><span class="w"> </span><span class="err">=</span><span class="w">     </span><span class="err">(</span><span class="w">
        </span><span class="err">...</span><span class="w">
    </span><span class="err">);</span><span class="w">
    </span><span class="err">fantasy</span><span class="w"> </span><span class="err">=</span><span class="w">     </span><span class="err">(</span><span class="w">
        </span><span class="err">...</span><span class="w">
    </span><span class="err">);</span><span class="w">
    </span><span class="err">monospace</span><span class="w"> </span><span class="err">=</span><span class="w">     </span><span class="err">(</span><span class="w">
        </span><span class="err">...</span><span class="w">
    </span><span class="err">);</span><span class="w">
    </span><span class="s2">"sans-serif"</span><span class="w"> </span><span class="err">=</span><span class="w">     </span><span class="err">(</span><span class="w">
        </span><span class="err">Helvetica</span><span class="p">,</span><span class="w">
        </span><span class="err">AppleColorEmoji</span><span class="p">,</span><span class="w">
        </span><span class="s2">".AppleSymbolsFB"</span><span class="p">,</span><span class="w">
                </span><span class="p">{</span><span class="w">
            </span><span class="err">ar</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">GeezaPro;</span><span class="w">
            </span><span class="err">ja</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="s2">"HiraginoSans-W3"</span><span class="err">;</span><span class="w">
            </span><span class="err">ko</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="s2">"AppleSDGothicNeo-Regular"</span><span class="err">;</span><span class="w">
            </span><span class="err">my</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="s2">"NotoSansMyanmar-Regular"</span><span class="err">;</span><span class="w">
            </span><span class="s2">"my-Qaag"</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="s2">"NotoSansZawgyi-Regular"</span><span class="err">;</span><span class="w">
            </span><span class="err">ur</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">NotoNastaliqUrdu;</span><span class="w">
            </span><span class="s2">"zh-HK"</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="s2">"PingFangHK-Regular"</span><span class="err">;</span><span class="w">
            </span><span class="s2">"zh-Hans"</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="s2">"PingFangSC-Regular"</span><span class="err">;</span><span class="w">
            </span><span class="s2">"zh-Hant"</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="s2">"PingFangTC-Regular"</span><span class="err">;</span><span class="w">
            </span><span class="s2">"zh-MO"</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="s2">"PingFangMO-Regular"</span><span class="err">;</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="err">Thonburi</span><span class="p">,</span><span class="w">
        </span><span class="err">ArialHebrew</span><span class="w">
    </span><span class="err">);</span><span class="w">
    </span><span class="err">serif</span><span class="w"> </span><span class="err">=</span><span class="w">     </span><span class="err">(</span><span class="w">
        </span><span class="err">...</span><span class="w">
    </span><span class="err">);</span><span class="w">
    </span><span class="s2">"ui-monospace"</span><span class="w"> </span><span class="err">=</span><span class="w">     </span><span class="err">(</span><span class="w">
        </span><span class="err">...</span><span class="w">
    </span><span class="err">);</span><span class="w">
    </span><span class="s2">"ui-rounded"</span><span class="w"> </span><span class="err">=</span><span class="w">     </span><span class="err">(</span><span class="w">
        </span><span class="err">...</span><span class="w">
    </span><span class="err">);</span><span class="w">
    </span><span class="s2">"ui-serif"</span><span class="w"> </span><span class="err">=</span><span class="w">     </span><span class="err">(</span><span class="w">
        </span><span class="err">...</span><span class="w">
    </span><span class="err">);</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p><code class="highlighter-rouge">DefaultFontFallbacks.plist</code>的格式基本和<code class="highlighter-rouge">CTPresetFallbacks.plist</code>类似，也是KV结构，Value部分也分为字符串和字典类型，字典类型也会根据用户指定语言来择优选取。</p>

<h2 id="53-解析并缓存系统默认fallback列表">5.3 解析并缓存系统默认Fallback列表</h2>

<p>解析和缓存逻辑主要由<code class="highlighter-rouge">CopyFontFallbacks</code>处理，主逻辑如下：</p>

<pre><code class="language-assembly">/**
 * CoreText 字体回退 - 复制字体回退列表函数
 * 功能: 根据字体描述符和语言信息复制相应的字体回退列表
 * 
 * 参数:
 *   a1 (_QWORD *): 输出参数指针，用于接收生成的字体回退数组
 *   a2 (__int64): 字体描述符对象指针
 *   a3 (__CFString *): 主要语言代码字符串
 *   a4 (__CFString *): 次要语言代码字符串（可选）
 *   a5 (__int64): 语言数组指针（可选）
 * 
 * 返回值:
 *   __int64: 操作结果
 */
__int64 __fastcall TFontFallbacks::CopyFontFallbacks(_QWORD *a1, __int64 a2, __CFString *a3, __CFString *a4, __int64 a5)
{
	...
  // 保存参数到局部变量和寄存器
  _X22 = a5;  // 语言数组指针
  v6 = a4;    // 次要语言代码
  v7 = a3;    // 主要语言代码
  v8 = a2;    // 字体描述符对象
  v9 = a1;    // 输出参数指针
  // 先在Font实例成员变量字典中查找Fallback缓存
  v16 = CFDictionaryGetValue(_X0, a3);
  ...
  // 如果没有找到缓存，则动态构建
  if ( !_X9 )
  {
  	...
    // 获取系统默认Fallback列表
    CopyDefaultFontFallbacks();
    v22 = objc_retain(_X0);
    if ( v22 )
    {
      // 用cssfamliy从系统默认Fallback列表中查找映射
      v24 = CFDictionaryGetValue(v22, v6);      
      // 检查是否找到了有效的字体列表
      if ( v24 &amp;&amp; CFArrayGetCount(v24) &gt;= 1 )
      {
      	...
      	// 解析列表
        // 根据用户指定语言、App偏好语言、系统设置偏好语言创建有序语言数组
        v29 = CreateOrderedLanguages(_X22);
        // 处理字体回退列表
        TDescriptorSource::ProcessFallbackList(v24, (__int64)&amp;v59, v31, v29);

        // 解析通用（common）字体回退列表
        v34 = CFDictionaryGetValue(_X25, &amp;stru_1F69C8);
        TDescriptorSource::ProcessFallbackList(v36, (__int64)&amp;v59, v31, v29);

				// 缓存结果到Font实例
        v44 = objc_retain(_X0);
        if ( v44 )
        {
        	...
        	CFDictionarySetValue(_X0, v7, _X2);
        }
      }
    }
  // 处理特定语言的回退逻辑
  ...
  return objc_release(v57);
}
</code></pre>

<p>注意CopyFontFallbacks中一共调了两次ProcessFallbackList，逻辑是先取对应CSSFamily的（比如sans-serif）Fallback列表，再取common的Fallback列表，最终将二者合并起来作为对应字体的Fallback结果。</p>

<p>ProcessFallbackList解析字体列表的逻辑和预设Fallback类似，也是根据Value是字符串类型还是字典类型来区分解析，此处不再赘述。</p>

<p>最后，CopyFontFallbacks还会将Fallback结果缓存到Font实例的字典变量中，key是<code class="highlighter-rouge">cssfamily + languages</code>（逗号分隔开），比如：<code class="highlighter-rouge">sans-serif,zh-HK</code></p>

<p><img src="/img/post/FontFallback/CopyFontFallbacks.png" alt="CopyFontFallbacks" /></p>

<p>CopyFontFallbacks逻辑比较清晰，总结下来是：</p>

<p><strong>1）先从Font实例中获取Fallback缓存，如果已经构建过则直接使用</strong></p>

<p><strong>2）缓存获取失败，走动态构建，将对应CSSFamily的Fallback列表和common的Fallback列表合并成最终Fallback结果</strong></p>

<p><strong>3）缓存Fallback结果到Font实例，key是<code class="highlighter-rouge">cssfamily + languages</code></strong></p>

<h2 id="54-语言处理与线程安全">5.4 语言处理与线程安全</h2>

<p>CopyFontFallbacksForLanguages在调用CopyFontFallbacks之前，会对用户指定的语言（即<code class="highlighter-rouge">CTFontCopyDefaultCascadeListForLanguages</code>的<code class="highlighter-rouge">languagePrefList</code>参数）进行处理：</p>

<pre><code class="language-assembly">__int64 __usercall TFontFallbacks::CopyFontFallbacksForLanguages@&lt;X0&gt;(__int64 a1@&lt;X0&gt;, __int64 a2@&lt;X1&gt;, __int64 a3@&lt;X2&gt;, __int64 a4@&lt;X8&gt;)
{
  // 如果没有提供语言数组，直接调用单语言版本
  if ( !a3 )
    return TFontFallbacks::CopyFontFallbacks((_QWORD *)a4, a1, (__CFString *)a2, 0LL, 0LL);
	...
  // 获取系统有序语言数组
  v7 = GetOrderedLanguages;
  // 遍历输入的语言代码数组
  do
  {
    // 检查规范化后的语言代码是否在系统支持的语言列表中
    __asm { LDAPR           X3, [X22], [X22] }
    if ( (unsigned int)CFArrayContainsValue(v7, 0LL, v8, _X3) )
    {
      // 如果支持，添加到有效语言数组中
      CFArrayAppendValue(v6, v21);

    }
    ++v12;
  }
  while ( v11 != v12 );
  ...
  // 如果找到了有效的语言代码
  if ( CFArrayGetCount(v6) )
  {
      TFontFallbacks::CopyFontFallbacks(v24, v25, _X2, v4, v6);
  }
  else
  {
    // 如果没有找到有效语言，使用单语言版本
    TFontFallbacks::CopyFontFallbacks(v24, v25, v4, 0LL, 0LL);
  }
  ...
}
</code></pre>

<p>大致逻辑是：</p>

<ul>
  <li>
    <p>如果<code class="highlighter-rouge">languagePrefList</code>传nil（注意空数组不算nil），则直接用cssfamily查询CopyFontFallbacks</p>
  </li>
  <li>
    <p>如果<code class="highlighter-rouge">languagePrefList</code>不为nil，会将用户指定的languages通过GetOrderedLanguages过滤一遍，去除系统不支持的language，然后使用cssfamily + languages查询CopyFontFallbacks</p>
  </li>
</ul>

<p>另外，<code class="highlighter-rouge">CopyFontFallbacks</code>会有对字典的读写操作，为了线程安全，CopyDefaultSubstitutionListForLanguages会对整个流程加一把大锁：</p>

<pre><code class="language-assembly">__int64 __usercall TDescriptorSource::CopyDefaultSubstitutionListForLanguages@&lt;X0&gt;(__int64 a1@&lt;X0&gt;, __int64 a2@&lt;X1&gt;, __int64 a3@&lt;X8&gt;)
{
  TDescriptorSource *v6; // 锁对象指针
  // 这个锁确保字体回退缓存的线程安全访问
  v6 = (TDescriptorSource *)os_unfair_lock_lock_with_options(&amp;TDescriptorSource::sFontFallbacksLock, 327680LL);
  ...
  TFontFallbacks::CopyFontFallbacksForLanguages(TDescriptorSource::sFontFallbacksCache, v4, v3, v5);
  // 释放字体回退缓存锁并返回
  return os_unfair_lock_unlock(&amp;TDescriptorSource::sFontFallbacksLock);
}
</code></pre>

<h2 id="55-结果处理与返回">5.5 结果处理与返回</h2>

<p>最后<code class="highlighter-rouge">CreateSystemDefaultFallbacks</code>会对<code class="highlighter-rouge">CopyDefaultSubstitutionListForLanguages</code>中获取到的字体描述符进行处理，即排除用户指定字体，防止自己Fallback自己。</p>

<h1 id="六总结">六、总结</h1>

<p>至此，我们通过逆向的手段梳理完了<code class="highlighter-rouge">CTFontCopyDefaultCascadeListForLanguages</code>的完整流程，最后整理下结论如下：</p>

<p>整体分为两个大流程：</p>

<p><strong>1、Preset Fallbacks：预设Fallback</strong></p>

<p>1.1 系统从全局常量CTPresetFallbacks中读取预设列表</p>

<p>1.2 根据用户指定主字体名从全局预设列表中查询Fallback数组</p>

<p>1.3 遍历Fallback数组，如果为字典类型，根据用户指定语言、App偏好语言、系统设置偏好语言来选择Fallback字体</p>

<p>1.4 遍历Fallback数组，如果为字符串类型，「直接」作为Fallback字体</p>

<p>1.5 Fallback数组遍历完后，对应字体的级联列表构建完成</p>

<p><strong>2、System Default Fallbacks：系统默认Fallback</strong></p>

<p>1.1 获取主字体的CSSFamily分类</p>

<p>1.2 从全局常量kDefaultFontFallbacks中读取默认Fallback列表</p>

<p>1.3 用<code class="highlighter-rouge">cssfamily + languages</code>从字体实例中获取Fallback缓存，如果已经构建则直接使用</p>

<p>1.4 缓存缺失则动态构建，根据CSSFamily获取对应字体的Fallback列表并解析，获取common类型的Fallback列表并解析，合并二者结果作为最终Fallback结果</p>

<p>1.5 用<code class="highlighter-rouge">cssfamily + languages</code>将Fallback结果缓存到Font实例</p>

<p>1.6 处理并返回Fallback结果</p>


                <hr>

                


                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/2025/10/01/%E6%96%87%E5%AD%97%E6%8E%92%E7%89%88%E5%BC%95%E6%93%8E/" data-toggle="tooltip" data-placement="top" title="从0到1自定义文字排版引擎：原理篇">&larr; Previous Post</a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/2025/10/11/%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0-%E6%96%B0%E6%89%8B%E5%BF%85%E5%A4%87-%E5%A6%82%E4%BD%95%E7%99%BD%E5%AB%96%E9%80%86%E5%90%91%E5%B7%A5%E5%85%B7/" data-toggle="tooltip" data-placement="top" title="【持续更新】新手必备！！如何白嫖逆向工具">Next Post &rarr;</a>
                    </li>
                    
                </ul>


                

                
                <!-- disqus 评论框 start -->
                <div class="comment">
                    <div id="disqus_thread" class="disqus-thread"></div>
                </div>
                <!-- disqus 评论框 end -->
                

            </div>

    <!-- Sidebar Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                
                <section>
                    <hr class="hidden-sm hidden-xs">
                    <h5><a href="/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
        				
                            
        				
                            
        				
                            
                				<a href="/tags/#Algorithm" title="Algorithm" rel="5">
                                    Algorithm
                                </a>
                            
        				
                            
        				
                            
                				<a href="/tags/#Java" title="Java" rel="14">
                                    Java
                                </a>
                            
        				
                            
                				<a href="/tags/#Android" title="Android" rel="10">
                                    Android
                                </a>
                            
        				
                            
                				<a href="/tags/#Hust" title="Hust" rel="2">
                                    Hust
                                </a>
                            
        				
                            
        				
                            
                				<a href="/tags/#操作系统" title="操作系统" rel="3">
                                    操作系统
                                </a>
                            
        				
                            
                				<a href="/tags/#View" title="View" rel="2">
                                    View
                                </a>
                            
        				
                            
        				
                            
        				
                            
        				
                            
                				<a href="/tags/#Note" title="Note" rel="2">
                                    Note
                                </a>
                            
        				
                            
                				<a href="/tags/#iOS" title="iOS" rel="6">
                                    iOS
                                </a>
                            
        				
                            
                				<a href="/tags/#跨端渲染" title="跨端渲染" rel="8">
                                    跨端渲染
                                </a>
                            
        				
                            
                				<a href="/tags/#Font" title="Font" rel="5">
                                    Font
                                </a>
                            
        				
                            
        				
                            
        				
                            
                				<a href="/tags/#逆向" title="逆向" rel="2">
                                    逆向
                                </a>
                            
        				
                            
                				<a href="/tags/#富文本" title="富文本" rel="2">
                                    富文本
                                </a>
                            
        				
        			</div>
                </section>
                

                <!-- Friends Blog -->
                
                <hr>
                <h5>FRIENDS</h5>
                <ul class="list-inline">
                    
                </ul>
                
            </div>
        </div>
    </div>
</article>





<!-- disqus 公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = "HusterYP";
    var disqus_identifier = "/2025/10/03/CoreText Font Fallback";
    var disqus_url = "http://localhost:4000/2025/10/03/CoreText-Font-Fallback/";

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<!-- disqus 公共JS代码 end -->




<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("http://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'always',
          placement: 'right',
          icon: '#'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>



    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    
                    

                    <!-- add Weibo, Zhihu by Hux, add target = "_blank" to <a> by Hux -->
                    
                    


                    
                    
                    <li>
                        <a target="_blank" href="https://github.com/HusterYP">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                </ul>
                <p class="copyright text-muted">
                    Copyright &copy; 非专业程序员 2025
                    <br>
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js "></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js "></script>

<!-- Custom Theme JavaScript -->
<script src="/js/hux-blog.min.js "></script>


<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!-- 
     Because of the native support for backtick-style fenced code blocks 
     right within the Markdown is landed in Github Pages, 
     From V1.6, There is no need for Highlight.js, 
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0  
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/    
-->
<!--
    <script>
        async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->


<!-- jquery.tagcloud.js -->
<script>
    // only load tagcloud.js in tag.html
    if($('#tag_cloud').length !== 0){
        async("/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>

<!--fastClick.js -->
<script>
    async("http://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->



<!-- Baidu Tongji -->




<!-- Image to hack wechat -->
<img src="/img/icon_wechat.png" width="0" height="0" />
<!-- Migrate from head to bottom, no longer block render and still work -->

</body>

</html>
